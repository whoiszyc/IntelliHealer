
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modeling Cookbook &#8212; IntelliHealer 0.1.0 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="modeling-cookbook">
<span id="modeling"></span><h1>Modeling Cookbook<a class="headerlink" href="#modeling-cookbook" title="Permalink to this headline">¶</a></h1>
<p>This chapter contains advanced topics on modeling and simulation and how they are implemented in ANDES.
It aims to provide an in-depth explanation of how the ANDES framework is set up for symbolic modeling and
numerical simulation. It also provides an example for interested users to implement customized DAE models.</p>
<div class="section" id="system">
<h2>System<a class="headerlink" href="#system" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>System is the top-level class for organizing power system models and orchestrating calculations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><cite>andes.System</cite> is an alias of <cite>andes.system.System</cite>.</p>
</div>
<div class="section" id="dynamic-imports">
<h4>Dynamic Imports<a class="headerlink" href="#dynamic-imports" title="Permalink to this headline">¶</a></h4>
<p>System dynamically imports groups, models, and routines at creation.
To add new models, groups or routines, edit the corresponding file by adding entries following examples.</p>
</div>
<div class="section" id="code-generation">
<h4>Code Generation<a class="headerlink" href="#code-generation" title="Permalink to this headline">¶</a></h4>
<p>Under the hood, all symbolically defined equations need to be generated into anonymous function calls for
accelerating numerical simulations.
This process is automatically invoked for the first time ANDES is run command line.
It takes several seconds up to a minute to finish the generation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Code generation has been done if one has executed <code class="docutils literal notranslate"><span class="pre">andes</span></code>, <code class="docutils literal notranslate"><span class="pre">andes</span> <span class="pre">selftest</span></code>, or <code class="docutils literal notranslate"><span class="pre">andes</span> <span class="pre">prepare</span></code>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When models are modified (such as adding new models or changing equation strings), code generation needs
to be executed again for consistency. It can be more conveniently triggered from command line with
<code class="docutils literal notranslate"><span class="pre">andes</span> <span class="pre">prepare</span> <span class="pre">-i</span></code>.</p>
</div>
<p>Since the process is slow, generated numerical functions (Python Callable) will be serialized into a file
for future speed up.
The package used for serializing/de-serializing numerical calls is <code class="docutils literal notranslate"><span class="pre">dill</span></code>.
System has a function called <code class="docutils literal notranslate"><span class="pre">dill</span></code> for serializing using the <code class="docutils literal notranslate"><span class="pre">dill</span></code> package.</p>
</div>
</div>
<div class="section" id="dae-storage">
<h3>DAE Storage<a class="headerlink" href="#dae-storage" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">System.dae</span></code> is an instance of the numerical DAE class.</p>
</div>
<div class="section" id="model-and-dae-values">
<h3>Model and DAE Values<a class="headerlink" href="#model-and-dae-values" title="Permalink to this headline">¶</a></h3>
<p>ANDES uses a decentralized architecture between models and DAE value arrays.
In this architecture, variables are initialized and equations are evaluated inside each model.
Then, <code class="docutils literal notranslate"><span class="pre">System</span></code> provides methods for collecting initial values and equation values into <code class="docutils literal notranslate"><span class="pre">DAE</span></code>, as well as
copying solved values to each model.</p>
<p>The collection of values from models needs to follow protocols to avoid conflicts.
Details are given in the subsection Variables.</p>
<div class="section" id="matrix-sparsity-patterns">
<h4>Matrix Sparsity Patterns<a class="headerlink" href="#matrix-sparsity-patterns" title="Permalink to this headline">¶</a></h4>
<p>The largest overhead in building and solving nonlinear equations is the building of Jacobian matrices.
This is especially relevant when we use the implicit integration approach which algebraized the differential
equations.
Given the unique data structure of power system models, the sparse matrices for Jacobians are built
<strong>incrementally</strong>, model after model.</p>
<p>There are two common approaches to incrementally build a sparse matrix. The first one is to use simple in-place
add on sparse matrices, such as doing</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">fx</span> <span class="o">+=</span> <span class="n">spmatrix</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Although the implementation is simple, it involves creating and discarding temporary objects on the right hand
side and, even worse, changing the sparse pattern of <code class="docutils literal notranslate"><span class="pre">self.fx</span></code>.</p>
<p>The second approach is to store the rows, columns and values in an array-like object and construct the Jacobians
at the end.
This approach is very efficient but has one caveat: it does not allow accessing the sparse matrix while building.</p>
<p>ANDES uses a pre-allocation approach to avoid the change of sparse patterns by filling values into a known the
sparse matrix pattern matrix.
System collects the indices of rows and columns for each Jacobian matrix.
Before in-place additions, ANDES builds a temporary zero-filled <cite>spmatrix</cite>, to which the actual Jacobian values
are written later.
Since these in-place add operations are only modifying existing values, it does not change the pattern and thus
avoids memory copying.
In addition, updating sparse matrices can be done with the exact same code as the first approach.</p>
<p>Still, this approach creates and discards temporary objects.
It is however feasible to write a C function which takes three array-likes and modify the sparse matrices in
place.
This is feature to be developed, and our prototype shows a promising acceleration up to 50%.</p>
</div>
</div>
<div class="section" id="calling-model-methods">
<h3>Calling Model Methods<a class="headerlink" href="#calling-model-methods" title="Permalink to this headline">¶</a></h3>
<p>System is an orchestrator for calling shared methods of models. These API methods are defined
for initialization, equation update, Jacobian update, and discrete flags update.</p>
<p>The following methods take an argument <cite>models</cite>, which should be an <cite>OrderedDict</cite> of models with names as keys
and instances as values.</p>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>System, models and routines have a member attribute <cite>config</cite> for model-specific or routine-specific configurations.
System manages all configs, including saving to a config file and loading back.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important to note that configs from files is passed to <em>model constructors</em> during instantiation.
If one needs to modify config for a run, it needs to be done before instantiating <code class="docutils literal notranslate"><span class="pre">System</span></code>, or before running
<code class="docutils literal notranslate"><span class="pre">andes</span></code> from command line.
Directly modifying <code class="docutils literal notranslate"><span class="pre">Model.config</span></code> may not take effect or have side effect as for the current implementation.</p>
</div>
</div>
</div>
<div class="section" id="group">
<h2>Group<a class="headerlink" href="#group" title="Permalink to this headline">¶</a></h2>
<p>A group is a collection of similar functional models with common variables and parameters.
It is mandatory to enforce the common variables and parameters when develop new models.
The common variables and parameters are typically the interface when connecting different group models.</p>
<p>For example, the Group <cite>RenGen</cite> has variables <cite>Pe</cite> and <cite>Qe</cite>, which are active power output and reactive power output.
Such common variables can be retrieved by other models, such as one in the
Group <cite>RenExciter</cite> for further calculation.</p>
<p>In such a way, the same variable interface is realized so that all model in the same group could carry out similar
function.</p>
</div>
<div class="section" id="models">
<h2>Models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h2>
<p>This section introduces the modeling of power system devices. The terminology “model” is used to describe the
mathematical representation of a <em>type</em> of device, such as synchronous generators or turbine governors. The
terminology “device” is used to describe a particular instance of a model, for example, a specific generator.</p>
<p>To define a model in ANDES, two classes, <code class="docutils literal notranslate"><span class="pre">ModelData</span></code> and <code class="docutils literal notranslate"><span class="pre">Model</span></code> need to be utilized. Class <code class="docutils literal notranslate"><span class="pre">ModelData</span></code> is
used for defining parameters that will be provided from input files. It provides API for adding data from
devices and managing the data.
Class <code class="docutils literal notranslate"><span class="pre">Model</span></code> is used for defining other non-input parameters, service
variables, and DAE variables. It provides API for converting symbolic equations, storing Jacobian patterns, and
updating equations.</p>
<div class="section" id="model-data">
<h3>Model Data<a class="headerlink" href="#model-data" title="Permalink to this headline">¶</a></h3>
<div class="section" id="cache">
<h4>Cache<a class="headerlink" href="#cache" title="Permalink to this headline">¶</a></h4>
<p><cite>ModelData</cite> uses a lightweight class <code class="xref py py-class docutils literal notranslate"><span class="pre">andes.core.model.ModelCache</span></code>
for caching its data as a dictionary
or a pandas DataFrame. Four attributes are defined in <cite>ModelData.cache</cite>:</p>
<ul class="simple">
<li><p><cite>dict</cite>: all data in a dictionary with the parameter names as keys and <cite>v</cite> values as arrays.</p></li>
<li><p><cite>dict_in</cite>: the same as <cite>dict</cite> except that the values are from <cite>v_in</cite>, the original input.</p></li>
<li><p><cite>df</cite>: all data in a pandas DataFrame.</p></li>
<li><p><cite>df_in</cite>: the same as <cite>df</cite> except that the values are from <cite>v_in</cite>.</p></li>
</ul>
<p>Other attributes can be added by registering with <cite>cache.add_callback</cite>.</p>
</div>
<div class="section" id="define-voltage-ratings">
<h4>Define Voltage Ratings<a class="headerlink" href="#define-voltage-ratings" title="Permalink to this headline">¶</a></h4>
<p>If a model is connected to an AC Bus or a DC Node, namely, if <code class="docutils literal notranslate"><span class="pre">bus</span></code>, <code class="docutils literal notranslate"><span class="pre">bus1</span></code>, <code class="docutils literal notranslate"><span class="pre">node</span></code> or <code class="docutils literal notranslate"><span class="pre">node1</span></code> exists
as parameter, it must provide the corresponding parameter, <code class="docutils literal notranslate"><span class="pre">Vn</span></code>, <code class="docutils literal notranslate"><span class="pre">Vn1</span></code>, <code class="docutils literal notranslate"><span class="pre">Vdcn</span></code> or <code class="docutils literal notranslate"><span class="pre">Vdcn1</span></code>, for rated
voltages.</p>
<p>Controllers not connected to Bus or Node will have its rated voltages omitted and thus <code class="docutils literal notranslate"><span class="pre">Vb</span> <span class="pre">=</span> <span class="pre">Vn</span> <span class="pre">=</span> <span class="pre">1</span></code>, unless
one uses <code class="xref py py-class docutils literal notranslate"><span class="pre">andes.core.param.ExtParam</span></code> to retrieve the bus/node values.</p>
<p>As a rule of thumb, controllers not directly connected to the network shall use system-base per unit for voltage
and current parameters.
Controllers (such as a turbine governor) may inherit rated power from controlled models and thus power parameters
will be converted consistently.</p>
</div>
</div>
<div class="section" id="define-a-dae-model">
<h3>Define a DAE Model<a class="headerlink" href="#define-a-dae-model" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="dynamicity-under-the-hood">
<h3>Dynamicity Under the Hood<a class="headerlink" href="#dynamicity-under-the-hood" title="Permalink to this headline">¶</a></h3>
<p>The magic for automatic creation of variables are all hidden in <code class="xref py py-func docutils literal notranslate"><span class="pre">andes.core.model.Model.__setattr__()</span></code>,
and the code is incredible simple.
It sets the name, tex_name, and owner model of the attribute instance and, more importantly,
does the book keeping.
In particular, when the attribute is a <code class="xref py py-class docutils literal notranslate"><span class="pre">andes.core.block.Block</span></code> subclass, <code class="docutils literal notranslate"><span class="pre">__setattr__</span></code> captures the
exported instances, recursively, and prepends the block name to exported ones.
All these convenience owe to the dynamic feature of Python.</p>
<p>During the code generation phase, the symbols are created by checking the book-keeping attributes, such as
<cite>states</cite>, <cite>algebs</cite>, and attributes in <cite>Model.cache</cite>.</p>
<p>In the numerical evaluation phase, <cite>Model</cite> provides a method, <code class="xref py py-func docutils literal notranslate"><span class="pre">andes.core.model.get_inputs()</span></code>, to
collect the variable value arrays in a dictionary, which can be effortlessly passed as arguments to numerical
functions.</p>
<div class="section" id="commonly-used-attributes-in-models">
<h4>Commonly Used Attributes in Models<a class="headerlink" href="#commonly-used-attributes-in-models" title="Permalink to this headline">¶</a></h4>
<p>The following <code class="docutils literal notranslate"><span class="pre">Model</span></code> attributes are commonly used for debugging.
If the attribute is an <cite>OrderedDict</cite>, the keys are attribute names in str, and corresponding values are the
instances.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code> and <code class="docutils literal notranslate"><span class="pre">params_ext</span></code>, two <cite>OrderedDict</cite> for internal (both numerical and non-numerical) and external
parameters, respectively.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_params</span></code> for numerical parameters, both internal and external.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">states</span></code> and <code class="docutils literal notranslate"><span class="pre">algebs</span></code>, two <code class="docutils literal notranslate"><span class="pre">OrderedDict</span></code> for state variables and algebraic variables, respectively.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">states_ext</span></code> and <code class="docutils literal notranslate"><span class="pre">algebs_ext</span></code>, two <code class="docutils literal notranslate"><span class="pre">OrderedDict</span></code> for external states and algebraics.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">discrete</span></code>, an <cite>OrderedDict</cite> for discrete components.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">blocks</span></code>, an <cite>OrderedDict</cite> for blocks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">services</span></code>, an <cite>OrderedDict</cite> for services with <code class="docutils literal notranslate"><span class="pre">v_str</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">services_ext</span></code>, an <cite>OrderedDict</cite> for externally retrieved services.</p></li>
</ul>
</div>
<div class="section" id="attributes-in-model-cache">
<h4>Attributes in <cite>Model.cache</cite><a class="headerlink" href="#attributes-in-model-cache" title="Permalink to this headline">¶</a></h4>
<p>Attributes in <cite>Model.cache</cite> are additional book-keeping structures for variables, parameters and services.
The following attributes are defined.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">all_vars</span></code>: all the variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_vars_names</span></code>, a list of all variable names.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_params</span></code>, all parameters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_params_names</span></code>, a list of all parameter names.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">algebs_and_ext</span></code>, an <cite>OrderedDict</cite> of internal and external algebraic variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">states_and_ext</span></code>, an <cite>OrderedDict</cite> of internal and external differential variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">services_and_ext</span></code>, an <cite>OrderedDict</cite> of internal and external service variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vars_int</span></code>, an <cite>OrderedDict</cite> of all internal variables, states and then algebs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vars_ext</span></code>, an <cite>OrderedDict</cite> of all external variables, states and then algebs.</p></li>
</ul>
</div>
</div>
<div class="section" id="equation-generation">
<h3>Equation Generation<a class="headerlink" href="#equation-generation" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Model.syms</span></code>, an instance of <code class="docutils literal notranslate"><span class="pre">SymProcessor</span></code>, handles the symbolic to numeric generation when called. The
equation generation is a multi-step process with symbol preparation, equation generation, Jacobian generation,
initializer generation, and pretty print generation.</p>
<p>Next, function <code class="docutils literal notranslate"><span class="pre">generate_equation</span></code> converts each DAE equation set to one numerical function calls and store
it in <code class="docutils literal notranslate"><span class="pre">Model.calls</span></code>. The attributes for differential equation set and algebraic equation set are <code class="docutils literal notranslate"><span class="pre">f</span></code>
and <code class="docutils literal notranslate"><span class="pre">g</span></code>. Differently, service variables will be generated one by one and store in an <code class="docutils literal notranslate"><span class="pre">OrderedDict</span></code>
in <code class="docutils literal notranslate"><span class="pre">Model.calls.s</span></code>.</p>
</div>
<div class="section" id="jacobian-storage">
<h3>Jacobian Storage<a class="headerlink" href="#jacobian-storage" title="Permalink to this headline">¶</a></h3>
<div class="section" id="abstract-jacobian-storage">
<h4>Abstract Jacobian Storage<a class="headerlink" href="#abstract-jacobian-storage" title="Permalink to this headline">¶</a></h4>
<p>Using the <code class="docutils literal notranslate"><span class="pre">.jacobian</span></code> method on <code class="docutils literal notranslate"><span class="pre">sympy.Matrix</span></code>, the symbolic Jacobians can be easily obtained. The complexity
lies in the storage of the Jacobian elements. Observed that the Jacobian equation generation happens before any
system is loaded, thus only the variable indices in the variable array is available. For each non-zero item in each
Jacobian matrix, ANDES stores the equation index, variable index, and the Jacobian value (either a constant
number or a callable function returning an array).</p>
<p>Note that, again, a non-zero entry in a Jacobian matrix can be either a constant or an expression. For efficiency,
constant numbers and lambdified callables are stored separately. Constant numbers, therefore, can be loaded into
the sparse matrix pattern when a particular system is given.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Data structure for the Jacobian storage has changed. Pending documentation update. Please check
<code class="xref py py-mod docutils literal notranslate"><span class="pre">andes.core.common.JacTriplet</span></code> class for more details.</p>
</div>
<p>The triplets, the equation (row) index, variable (column) index, and values (constant numbers or callable) are
stored in <code class="docutils literal notranslate"><span class="pre">Model</span></code> attributes with the name of <code class="docutils literal notranslate"><span class="pre">_{i,</span> <span class="pre">j,</span> <span class="pre">v}{Jacobian</span> <span class="pre">Name}{c</span> <span class="pre">or</span> <span class="pre">None}</span></code>, where
<code class="docutils literal notranslate"><span class="pre">{i,</span> <span class="pre">j,</span> <span class="pre">v}</span></code> is a single character for row, column or value, <code class="docutils literal notranslate"><span class="pre">{Jacobian</span> <span class="pre">Name}</span></code> is a two-character Jacobian
name chosen from <code class="docutils literal notranslate"><span class="pre">fx,</span> <span class="pre">fy,</span> <span class="pre">gx,</span> <span class="pre">and</span> <span class="pre">gy</span></code>, and <code class="docutils literal notranslate"><span class="pre">{c</span> <span class="pre">or</span> <span class="pre">None}</span></code> is either character <code class="docutils literal notranslate"><span class="pre">c</span></code> or no character,
indicating whether it corresponds to the constants or non-constants in the Jacobian.</p>
<p>For example, the triplets for the
constants in Jacobian <code class="docutils literal notranslate"><span class="pre">gy</span></code> are stored in <code class="docutils literal notranslate"><span class="pre">_igyc</span></code>, <code class="docutils literal notranslate"><span class="pre">_jgyc</span></code>, and <code class="docutils literal notranslate"><span class="pre">_vgyc</span></code>.</p>
<p>In terms of the non-constant entries in Jacobians, the callable functions are stored in the corresponding
<code class="docutils literal notranslate"><span class="pre">_v{Jacobian</span> <span class="pre">Name}</span></code> array. Note the differences between, for example, <code class="docutils literal notranslate"><span class="pre">_vgy</span></code> an <code class="docutils literal notranslate"><span class="pre">_vgyc</span></code>: <code class="docutils literal notranslate"><span class="pre">_vgy</span></code> is a
list of callables, while <code class="docutils literal notranslate"><span class="pre">_vgyc</span></code> is a list of constant numbers.</p>
</div>
<div class="section" id="concrete-jacobian-storage">
<h4>Concrete Jacobian Storage<a class="headerlink" href="#concrete-jacobian-storage" title="Permalink to this headline">¶</a></h4>
<p>When a specific system is loaded and the addresses are assigned to variables, the abstract Jacobian triplets,
more specifically, the rows and columns, are replaced with the array of addresses. The new addresses and values
will be stored in <code class="docutils literal notranslate"><span class="pre">Model</span></code> attributes with the names <code class="docutils literal notranslate"><span class="pre">{i,</span> <span class="pre">j,</span> <span class="pre">v}{Jacobian</span> <span class="pre">Name}{c</span> <span class="pre">or</span> <span class="pre">None}</span></code>. Note that there
is no underscore for the concrete Jacobian triplets.</p>
<p>For example, if model <code class="docutils literal notranslate"><span class="pre">PV</span></code> has a list of variables <code class="docutils literal notranslate"><span class="pre">[p,</span> <span class="pre">q,</span> <span class="pre">a,</span> <span class="pre">v]</span></code> .
The equation associated with <code class="docutils literal notranslate"><span class="pre">p</span></code> is <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">u</span> <span class="pre">*</span> <span class="pre">p0</span></code>, and the equation associated with <code class="docutils literal notranslate"><span class="pre">q</span></code> is <code class="docutils literal notranslate"><span class="pre">u</span> <span class="pre">*</span> <span class="pre">(v0</span> <span class="pre">-</span> <span class="pre">v)</span></code>.
Therefore, the derivative of equation <code class="docutils literal notranslate"><span class="pre">v0</span> <span class="pre">-</span> <span class="pre">v</span></code> over <code class="docutils literal notranslate"><span class="pre">v</span></code> is <code class="docutils literal notranslate"><span class="pre">-u</span></code>. Note that <code class="docutils literal notranslate"><span class="pre">u</span></code> is unknown at generation
time, thus the value is NOT a constant and should to go <code class="docutils literal notranslate"><span class="pre">vgy</span></code>.</p>
<p>The values in <code class="docutils literal notranslate"><span class="pre">_igy</span></code>, <code class="docutils literal notranslate"><span class="pre">_jgy</span></code> and <code class="docutils literal notranslate"><span class="pre">_vgy</span></code> contains, respectively, <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">3</span></code>, and a lambda function which
returns <code class="docutils literal notranslate"><span class="pre">-u</span></code>.</p>
<p>When a specific system is loaded, for example, a 5-bus system, the addresses for the <code class="docutils literal notranslate"><span class="pre">q</span></code> and <code class="docutils literal notranslate"><span class="pre">v</span></code> are <code class="docutils literal notranslate"><span class="pre">[11,</span>
<span class="pre">13,</span> <span class="pre">15</span></code>, and <code class="docutils literal notranslate"><span class="pre">[5,</span> <span class="pre">7,</span> <span class="pre">9]</span></code>.
<code class="docutils literal notranslate"><span class="pre">PV.igy</span></code> and <code class="docutils literal notranslate"><span class="pre">PV.jgy</span></code> will thus query the corresponding address list based on <code class="docutils literal notranslate"><span class="pre">PV._igy</span></code> and <code class="docutils literal notranslate"><span class="pre">PV._jgy</span></code>
and store <code class="docutils literal notranslate"><span class="pre">[11,</span> <span class="pre">13,</span> <span class="pre">15</span></code>, and <code class="docutils literal notranslate"><span class="pre">[5,</span> <span class="pre">7,</span> <span class="pre">9]</span></code>.</p>
</div>
</div>
<div class="section" id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h3>
<p>Value providers such as services and DAE variables need to be initialized. Services are initialized before
any DAE variable. Both Services and DAE Variables are initialized <em>sequentially</em> in the order of declaration.</p>
<p>Each Service, in addition to the standard <code class="docutils literal notranslate"><span class="pre">v_str</span></code> for symbolic initialization, provides a <code class="docutils literal notranslate"><span class="pre">v_numeric</span></code> hook
for specifying a custom function for initialization. Custom initialization functions for DAE variables, are
lumped in a single function in <code class="docutils literal notranslate"><span class="pre">Model.v_numeric</span></code>.</p>
<p>ANDES has an <em>experimental</em> Newton-Krylov method based iterative initialization. All DAE variables with <code class="docutils literal notranslate"><span class="pre">v_iter</span></code>
will be initialized using the iterative approach</p>
</div>
<div class="section" id="additional-numerical-equations">
<h3>Additional Numerical Equations<a class="headerlink" href="#additional-numerical-equations" title="Permalink to this headline">¶</a></h3>
<p>Addition numerical equations are allowed to complete the “hybrid symbolic-numeric” framework. Numerical function
calls are useful when the model DAE is non-standard or hard to be generalized. Since the
symbolic-to-numeric generation is an additional layer on top of the numerical simulation, it is fundamentally
the same as user-provided numerical function calls.</p>
<p>ANDES provides the following hook functions in each <code class="docutils literal notranslate"><span class="pre">Model</span></code> subclass for custom numerical functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">v_numeric</span></code>: custom initialization function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s_numeric</span></code>: custom service value function</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">g_numeric</span></code>: custom algebraic equations; update the <code class="docutils literal notranslate"><span class="pre">e</span></code> of the corresponding variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f_numeric</span></code>: custom differential equations; update the <code class="docutils literal notranslate"><span class="pre">e</span></code> of the corresponding variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">j_numeric</span></code>: custom Jacobian equations; the function should append to <code class="docutils literal notranslate"><span class="pre">_i</span></code>, <code class="docutils literal notranslate"><span class="pre">_j</span></code> and <code class="docutils literal notranslate"><span class="pre">_v</span></code> structures.</p></li>
</ul>
<p>For most models, numerical function calls are unnecessary and not recommended as it increases code complexity.
However, when the data structure or the DAE are difficult to generalize in the symbolic framework, the numerical
equations can be used.</p>
<p>For interested readers, see the <code class="docutils literal notranslate"><span class="pre">COI</span></code> symbolic implementation which calculated the
center-of-inertia speed of generators. The <code class="docutils literal notranslate"><span class="pre">COI</span></code> could have been implemented numerically with for loops
instead of <code class="docutils literal notranslate"><span class="pre">NumReduce</span></code>, <code class="docutils literal notranslate"><span class="pre">NumRepeat</span></code> and external variables.</p>
</div>
</div>
<div class="section" id="atom-types">
<h2>Atom Types<a class="headerlink" href="#atom-types" title="Permalink to this headline">¶</a></h2>
<p>ANDES contains three types of atom classes for building DAE models.
These types are parameter, variable and service.</p>
<div class="section" id="value-provider">
<h3>Value Provider<a class="headerlink" href="#value-provider" title="Permalink to this headline">¶</a></h3>
<p>Before addressing specific atom classes, the terminology <cite>v-provider</cite>, and <cite>e-provider</cite> are discussed.
A value provider class (or <cite>v-provider</cite> for short) references any class with a member attribute named <code class="docutils literal notranslate"><span class="pre">v</span></code>,
which should be a list or a 1-dimensional array of values.
For example, all parameter classes are v-providers, since a parameter class should provide
values for that parameter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In fact, all types of atom classes are v-providers, meaning that an instance of an atom class must contain values.</p>
</div>
<p>The values in the <cite>v</cite> attribute of a particular instance are values that will substitute the instance for computation.
If in a model, one has a parameter</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span> <span class="o">=</span> <span class="n">NumParam</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">NumParam</span><span class="p">()</span>

<span class="c1"># where self.v0.v = np.array([1., 1.05, 1.1]</span>
<span class="c1">#   and self.b.v  = np.array([10., 10., 10.]</span>
</pre></div>
</div>
<p>Later, this parameter is used in an equation, such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">ExtAlgeb</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;Bus&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
                  <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="p">,</span>
                  <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;v0 **2 * b&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>While computing <cite>v0 ** 2 * b</cite>, <cite>v0</cite> and <cite>b</cite> will be substituted with the values in <cite>self.v0.v</cite> and <cite>self.b.v</cite>.</p>
<p>Sharing this interface <cite>v</cite> allows interoperability among parameters and variables and services.
In the above example, if one defines <cite>v0</cite> as a <cite>ConstService</cite> instance, such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span> <span class="o">=</span> <span class="n">ConstService</span><span class="p">(</span><span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Calculations will still work without modification.</p>
</div>
<div class="section" id="equation-provider">
<h3>Equation Provider<a class="headerlink" href="#equation-provider" title="Permalink to this headline">¶</a></h3>
<p>Similarly, an equation provider class (or <cite>e-provider</cite>) references any class with a member attribute named <code class="docutils literal notranslate"><span class="pre">e</span></code>,
which should be a 1-dimensional array of values.
The values in the <cite>e</cite> array are the results from the equation and will be summed to the numerical DAE at the addresses
specified by the attribute <cite>a</cite>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, only variables are <cite>e-provider</cite> types.</p>
</div>
<p>If a model has an external variable that links to Bus.v (voltage), such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">ExtAlgeb</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;Bus&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
                  <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="p">,</span>
                  <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;v0 **2 * b&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The addresses of the corresponding voltage variables will be retrieved into <cite>self.v.a</cite>,
and the equation evaluation results will be stored in <cite>self.v.e</cite></p>
</div>
</div>
<div class="section" id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h2>
<div class="section" id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h3>
<p>Parameter is a type of building atom for DAE models.
Most parameters are read directly from an input file and passed to equation,
and other parameters can be calculated from existing parameters.</p>
<p>The base class for parameters in ANDES is <cite>BaseParam</cite>, which defines interfaces for adding values and
checking the number of values. <cite>BaseParam</cite> has its values stored in a plain list, the member attribute <cite>v</cite>.
Subclasses such as <cite>NumParam</cite> stores values using a NumPy ndarray.</p>
<p>An overview of supported parameters is given below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 84%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Subclasses</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DataParam</p></td>
<td><p>An alias of <cite>BaseParam</cite>. Can be used for any non-numerical parameters.</p></td>
</tr>
<tr class="row-odd"><td><p>NumParam</p></td>
<td><p>The numerical parameter type. Used for all parameters in equations</p></td>
</tr>
<tr class="row-even"><td><p>IdxParam</p></td>
<td><p>The parameter type for storing <cite>idx</cite> into other models</p></td>
</tr>
<tr class="row-odd"><td><p>ExtParam</p></td>
<td><p>Externally defined parameter</p></td>
</tr>
<tr class="row-even"><td><p>TimerParam</p></td>
<td><p>Parameter for storing the action time of events</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="data-parameters">
<h3>Data Parameters<a class="headerlink" href="#data-parameters" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="numeric-parameters">
<h3>Numeric Parameters<a class="headerlink" href="#numeric-parameters" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="external-parameters">
<h3>External Parameters<a class="headerlink" href="#external-parameters" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="timer-parameter">
<h3>Timer Parameter<a class="headerlink" href="#timer-parameter" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="variables">
<h2>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h2>
<p>DAE Variables, or variables for short, are unknowns to be solved using numerical or analytical methods.
A variable stores values, equation values, and addresses in the DAE array. The base class for variables is
<cite>BaseVar</cite>.
In this subsection, <cite>BaseVar</cite> is used to represent any subclass of <cite>VarBase</cite> list in the table below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>State</p></td>
<td><p>A state variable and associated diff. equation <span class="math notranslate nohighlight">\(\textbf{T} \dot{x} = \textbf{f}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>Algeb</p></td>
<td><p>An algebraic variable and an associated algebraic equation <span class="math notranslate nohighlight">\(0 = \textbf{g}\)</span></p></td>
</tr>
<tr class="row-even"><td><p>ExtState</p></td>
<td><p>An external state variable and part of the differential equation (uncommon)</p></td>
</tr>
<tr class="row-odd"><td><p>ExtAlgeb</p></td>
<td><p>An external algebraic variable and part of the algebraic equation</p></td>
</tr>
</tbody>
</table>
<p><cite>BaseVar</cite> has two types: the differential variable type <cite>State</cite> and the algebraic variable type <cite>Algeb</cite>.
State variables are described by differential equations, whereas algebraic variables are described by
algebraic equations. State variables can only change continuously, while algebraic variables
can be discontinuous.</p>
<p>Based on the model the variable is defined, variables can be internal or external. Most variables are internal
and only appear in equations in the same model.
Some models have “public” variables that can be accessed by other
models. For example, a <cite>Bus</cite> defines <cite>v</cite> for the voltage magnitude.
Each device attached to a particular bus needs to access the value and impose the reactive power injection.
It can be done with <cite>ExtAlgeb</cite> or <cite>ExtState</cite>, which links with an existing variable from a model or a group.</p>
<div class="section" id="variable-equation-and-address">
<h3>Variable, Equation and Address<a class="headerlink" href="#variable-equation-and-address" title="Permalink to this headline">¶</a></h3>
<p>Subclasses of <cite>BaseVar</cite> are value providers and equation providers.
Each <cite>BaseVar</cite> has member attributes <cite>v</cite> and <cite>e</cite> for variable values and equation values, respectively.
The initial value of <cite>v</cite> is set by the initialization routine, and the initial value of <cite>e</cite> is set to zero.
In the process of power flow calculation or time domain simulation, <cite>v</cite> is not directly modifiable by models
but rather updated after solving non-linear equations. <cite>e</cite> is updated by the models and summed up before
solving equations.</p>
<p>Each <cite>BaseVar</cite> also stores addresses of this variable, for all devices, in its member attribute <cite>a</cite>. The
addresses are <em>0-based</em> indices into the numerical DAE array, <cite>f</cite> or <cite>g</cite>, based on the variable type.</p>
<p>For example, <cite>Bus</cite> has <code class="docutils literal notranslate"><span class="pre">self.a</span> <span class="pre">=</span> <span class="pre">Algeb()</span></code> as the voltage phase angle variable.
For a 5-bus system, <code class="docutils literal notranslate"><span class="pre">Bus.a.a</span></code> stores the addresses of the <cite>a</cite> variable for all
the five Bus devices. Conventionally, <cite>Bus.a.a</cite> will be assigned <cite>np.array([0, 1, 2, 3, 4])</cite>.</p>
</div>
<div class="section" id="value-and-equation-strings">
<h3>Value and Equation Strings<a class="headerlink" href="#value-and-equation-strings" title="Permalink to this headline">¶</a></h3>
<p>The most important feature of the symbolic framework is allowing to define equations using strings.
There are three types of strings for a variable, stored in the following member attributes, respectively:</p>
<ul class="simple">
<li><p><cite>v_str</cite>: equation string for <strong>explicit</strong> initialization in the form of <cite>v = v_str(x, y)</cite>.</p></li>
<li><p><cite>v_iter</cite>: equation string for <strong>implicit</strong> initialization in the form of <cite>v_iter(x, y) = 0</cite></p></li>
<li><p><cite>e_str</cite>: equation string for (full or part of) the differential or algebraic equation.</p></li>
</ul>
<p>The difference between <cite>v_str</cite> and <cite>v_iter</cite> should be clearly noted. <cite>v_str</cite> evaluates directly into the
initial value, while all <cite>v_iter</cite> equations are solved numerically using the Newton-Krylov iterative method.</p>
</div>
<div class="section" id="values-between-dae-and-models">
<h3>Values Between DAE and Models<a class="headerlink" href="#values-between-dae-and-models" title="Permalink to this headline">¶</a></h3>
<p>ANDES adopts a decentralized architecture which provides each model a copy of variable values before equation
evaluation. This architecture allows to parallelize the equation evaluation (in theory, or in practice if one
works round the Python GIL). However, this architecture requires a coherent protocol for updating the DAE arrays
and the <code class="docutils literal notranslate"><span class="pre">BaseVar</span></code> arrays. More specifically, how the variable and equations values from model <code class="docutils literal notranslate"><span class="pre">VarBase</span></code>
should be summed up or forcefully set at the DAE arrays needs to be defined.</p>
<p>The protocol is relevant when a model defines subclasses of <cite>BaseVar</cite> that are supposed to be “public”.
Other models share this variable with <cite>ExtAlgeb</cite> or <cite>ExtState</cite>.</p>
<p>By default, all <cite>v</cite> and <cite>e</cite> at the same address are summed up.
This is the most common case, such as a Bus connected by multiple devices: power injections from
devices should be summed up.</p>
<p>In addition, <cite>BaseVar</cite> provides two flags, <cite>v_setter</cite> and <cite>e_setter</cite>, for cases when one <cite>VarBase</cite>
needs to overwrite the variable or equation values.</p>
</div>
<div class="section" id="flags-for-value-overwriting">
<h3>Flags for Value Overwriting<a class="headerlink" href="#flags-for-value-overwriting" title="Permalink to this headline">¶</a></h3>
<p><cite>BaseVar</cite> have special flags for handling value initialization and equation values.
This is only relevant for public or external variables.
The <cite>v_setter</cite> is used to indicate whether a particular <cite>BaseVar</cite> instance sets the initial value.
The <cite>e_setter</cite> flag indicates whether the equation associated with a <cite>BaseVar</cite> sets the equation value.</p>
<p>The <cite>v_setter</cite> flag is checked when collecting data from models to the numerical DAE array. If
<cite>v_setter is False</cite>, variable values of the same address will be added.
If one of the variable or external variable has <cite>v_setter is True</cite>, it will, at the end, set the values in the
DAE array to its value. Only one <cite>BaseVar</cite> of the same address is allowed to have <cite>v_setter == True</cite>.</p>
</div>
<div class="section" id="a-v-setter-example">
<h3>A <cite>v_setter</cite> Example<a class="headerlink" href="#a-v-setter-example" title="Permalink to this headline">¶</a></h3>
<p>A Bus is allowed to default the initial voltage magnitude to 1 and the voltage phase angle to 0.
If a PV device is connected to a Bus device, the PV should be allowed to override the voltage initial value
with the voltage set point.</p>
<p>In <cite>Bus.__init__()</cite>, one has</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In <cite>PV.__init__</cite>, one can use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">v0</span> <span class="o">=</span> <span class="n">Param</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">IdxParam</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;Bus&#39;</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">ExtAlgeb</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
                  <span class="n">model</span><span class="o">=</span><span class="s1">&#39;Bus&#39;</span><span class="p">,</span>
                  <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="p">,</span>
                  <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;v0&#39;</span><span class="p">,</span>
                  <span class="n">v_setter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>where an <cite>ExtAlgeb</cite> is defined to access <cite>Bus.v</cite> using indexer <cite>self.bus</cite>. The <cite>v_str</cite> line sets the
initial value to <cite>v0</cite>. In the variable initialization phase for <cite>PV</cite>, <cite>PV.v.v</cite> is set to <cite>v0</cite>.</p>
<p>During the value collection into <cite>DAE.y</cite> by the <cite>System</cite> class, <cite>PV.v</cite>, as a final <cite>v_setter</cite>, will
overwrite the voltage magnitude for Bus devices with the indices provided in <cite>PV.bus</cite>.</p>
</div>
</div>
<div class="section" id="services">
<h2>Services<a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h2>
<p>Services are helper variables outside the DAE variable list. Services are most often used for storing intermediate
constants but can be used for special operations to work around restrictions in the symbolic framework.
Services are value providers, meaning each service has an attribute <code class="docutils literal notranslate"><span class="pre">v</span></code> for storing service values. The
base class of services is <code class="docutils literal notranslate"><span class="pre">BaseService</span></code>, and the supported services are listed as follows.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ConstService</p></td>
<td><p>Internal service for constant values.</p></td>
</tr>
<tr class="row-odd"><td><p>VarService</p></td>
<td><p>Variable service updated at each iteration before equations.</p></td>
</tr>
<tr class="row-even"><td><p>ExtService</p></td>
<td><p>External service for retrieving values from value providers.</p></td>
</tr>
<tr class="row-odd"><td><p>PostInitService</p></td>
<td><p>Constant service evaluated after TDS initialization</p></td>
</tr>
<tr class="row-even"><td><p>NumReduce</p></td>
<td><p>The service type for reducing linear 2-D arrays into 1-D arrays</p></td>
</tr>
<tr class="row-odd"><td><p>NumRepeat</p></td>
<td><p>The service type for repeating a 1-D array to linear 2-D arrays</p></td>
</tr>
<tr class="row-even"><td><p>IdxRepeat</p></td>
<td><p>The service type for repeating a 1-D list to linear 2-D list</p></td>
</tr>
<tr class="row-odd"><td><p>EventFlag</p></td>
<td><p>Service type for flagging changes in inputs as an event</p></td>
</tr>
<tr class="row-even"><td><p>VarHold</p></td>
<td><p>Hold input value when a hold signal is active</p></td>
</tr>
<tr class="row-odd"><td><p>ExtendedEvent</p></td>
<td><p>Extend an event signal for a given period of time</p></td>
</tr>
<tr class="row-even"><td><p>DataSelect</p></td>
<td><p>Select optional str data if provided or use the fallback</p></td>
</tr>
<tr class="row-odd"><td><p>NumSelect</p></td>
<td><p>Select optional numerical data if provided</p></td>
</tr>
<tr class="row-even"><td><p>DeviceFinder</p></td>
<td><p>Finds or creates devices linked to the given devices</p></td>
</tr>
<tr class="row-odd"><td><p>BackRef</p></td>
<td><p>Collects idx-es for the backward references</p></td>
</tr>
<tr class="row-even"><td><p>RefFlatten</p></td>
<td><p>Converts BackRef list of lists into a 1-D list</p></td>
</tr>
<tr class="row-odd"><td><p>InitChecker</p></td>
<td><p>Checks initial values against typical values</p></td>
</tr>
<tr class="row-even"><td><p>FlagValue</p></td>
<td><p>Flags values that equals the given value</p></td>
</tr>
<tr class="row-odd"><td><p>Replace</p></td>
<td><p>Replace values that returns True for the given lambda func</p></td>
</tr>
</tbody>
</table>
<div class="section" id="internal-constants">
<h3>Internal Constants<a class="headerlink" href="#internal-constants" title="Permalink to this headline">¶</a></h3>
<p>The most commonly used service is <cite>ConstService</cite>.  It is used to store an array of constants, whose value is
evaluated from a provided symbolic string. They are only evaluated once in the model initialization phase, ahead
of variable initialization. <cite>ConstService</cite> comes handy when one wants to calculate intermediate constants from
parameters.</p>
<p>For example, a turbine governor has a <cite>NumParam</cite> <cite>R</cite> for the
droop. <cite>ConstService</cite> allows to calculate the inverse of the droop, the gain, and use it in equations. The
snippet from a turbine governor’s <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> may look like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">NumParam</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">ConstService</span><span class="p">(</span><span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;u/R&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>where <cite>u</cite> is the online status parameter. The model can thus use <cite>G</cite> in subsequent variable or equation
strings.</p>
</div>
<div class="section" id="external-constants">
<h3>External Constants<a class="headerlink" href="#external-constants" title="Permalink to this headline">¶</a></h3>
<p>Service constants whose value is retrieved from an external model or group. Using <cite>ExtService</cite> is
similar to using external variables. The values of <cite>ExtService</cite> will be retrieved once during the
initialization phase before <cite>ConstService</cite> evaluation.</p>
<p>For example, a synchronous generator needs to retrieve the <cite>p</cite> and <cite>q</cite> values from static generators
for initialization. <cite>ExtService</cite> is used for this purpose. In the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> of a synchronous generator
model, one can define the following to retrieve <cite>StaticGen.p</cite> as <cite>p0</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">p0</span> <span class="o">=</span> <span class="n">ExtService</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span>
                     <span class="n">model</span><span class="o">=</span><span class="s1">&#39;StaticGen&#39;</span><span class="p">,</span>
                     <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">,</span>
                     <span class="n">tex_name</span><span class="o">=</span><span class="s1">&#39;P_0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="shape-manipulators">
<h3>Shape Manipulators<a class="headerlink" href="#shape-manipulators" title="Permalink to this headline">¶</a></h3>
<p>This section is for advanced model developer.</p>
<p>All generated equations operate on 1-dimensional arrays and can use algebraic calculations only.
In some cases, one model would use <cite>BackRef</cite> to retrieve 2-dimensional indices and will use such indices to
retrieve variable addresses.
The retrieved addresses usually has a different length of the referencing model and cannot be used directly for calculation.
Shape manipulator services can be used in such case.</p>
<p><cite>NumReduce</cite> is a helper Service type which reduces a linearly stored 2-D ExtParam into 1-D Service.
<cite>NumRepeat</cite> is a helper Service type which repeats a 1-D value into linearly stored 2-D value based on the
shape from a <cite>BackRef</cite>.</p>
</div>
<div class="section" id="value-manipulation">
<h3>Value Manipulation<a class="headerlink" href="#value-manipulation" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="idx-and-references">
<h3>Idx and References<a class="headerlink" href="#idx-and-references" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="events">
<h3>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="data-select">
<h3>Data Select<a class="headerlink" href="#data-select" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="miscellaneous">
<h3>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="discrete">
<h2>Discrete<a class="headerlink" href="#discrete" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Background<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The discrete component library contains a special type of block for modeling the discontinuity in power system
devices. Such continuities can be device-level physical constraints or algorithmic limits imposed on controllers.</p>
<p>The base class for discrete components is <code class="xref py py-mod docutils literal notranslate"><span class="pre">andes.core.discrete.Discrete</span></code>.</p>
<p>The uniqueness of discrete components is the way it works.
Discrete components take inputs, criteria, and exports a set of flags with the component-defined meanings.
These exported flags can be used in algebraic or differential equations to build piece-wise equations.</p>
<p>For example, <cite>Limiter</cite> takes a v-provider as input, two v-providers as the upper and the lower bound.
It exports three flags: <cite>zi</cite> (within bound), <cite>zl</cite> (below lower bound), and <cite>zu</cite> (above upper bound).
See the code example in <code class="docutils literal notranslate"><span class="pre">models/pv.py</span></code> for an example voltage-based PQ-to-Z conversion.</p>
<p>It is important to note when the flags are updated.
Discrete subclasses can use three methods to check and update the value and equations.
Among these methods, <cite>check_var</cite> is called <em>before</em> equation evaluation, but <cite>check_eq</cite> and <cite>set_eq</cite> are
called <em>after</em> equation update.
In the current implementation, <cite>check_var</cite> updates flags for variable-based discrete components (such as
<cite>Limiter</cite>).
<cite>check_eq</cite> updates flags for equation-involved discrete components (such as <cite>AntiWindup</cite>).
<cite>set_var`</cite> is currently only used by <cite>AntiWindup</cite> to store the pegged states.</p>
<p>ANDES includes the following types of discrete components.</p>
</div>
<div class="section" id="limiters">
<h3>Limiters<a class="headerlink" href="#limiters" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="comparers">
<h3>Comparers<a class="headerlink" href="#comparers" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="deadband">
<h3>Deadband<a class="headerlink" href="#deadband" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="blocks">
<h2>Blocks<a class="headerlink" href="#blocks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>Background<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The block library contains commonly used blocks (such as transfer functions and nonlinear functions).
Variables and equations are pre-defined for blocks to be used as “lego pieces” for scripting DAE models.
The base class for blocks is <code class="xref py py-mod docutils literal notranslate"><span class="pre">andes.core.block.Block</span></code>.</p>
<p>The supported blocks include <code class="docutils literal notranslate"><span class="pre">Lag</span></code>, <code class="docutils literal notranslate"><span class="pre">LeadLag</span></code>, <code class="docutils literal notranslate"><span class="pre">Washout</span></code>, <code class="docutils literal notranslate"><span class="pre">LeadLagLimit</span></code>, <code class="docutils literal notranslate"><span class="pre">PIController</span></code>. In addition,
the base class for piece-wise nonlinear functions, <code class="docutils literal notranslate"><span class="pre">PieceWise</span></code> is provided. <code class="docutils literal notranslate"><span class="pre">PieceWise</span></code> is used for
implementing the quadratic saturation function <code class="docutils literal notranslate"><span class="pre">MagneticQuadSat</span></code> and exponential saturation function
<code class="docutils literal notranslate"><span class="pre">MagneticExpSat</span></code>.</p>
<p>All variables in a block must be defined as attributes in the constructor, just like variable definition in
models. The difference is that the variables are “exported” from a block to the capturing model. All exported
variables need to placed in a dictionary, <code class="docutils literal notranslate"><span class="pre">self.vars</span></code> at the end of the block constructor.</p>
<p>Blocks can be nested as advanced usage. See the following API documentation for more details.</p>
</div>
<div class="section" id="transfer-functions">
<h3>Transfer Functions<a class="headerlink" href="#transfer-functions" title="Permalink to this headline">¶</a></h3>
<p>The following transfer function blocks have been implemented.
They can be imported to build new models.</p>
<div class="section" id="algebraic">
<h4>Algebraic<a class="headerlink" href="#algebraic" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="first-order">
<h4>First Order<a class="headerlink" href="#first-order" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="second-order">
<h4>Second Order<a class="headerlink" href="#second-order" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="saturation">
<h3>Saturation<a class="headerlink" href="#saturation" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="others">
<h3>Others<a class="headerlink" href="#others" title="Permalink to this headline">¶</a></h3>
<div class="section" id="value-selector">
<h4>Value Selector<a class="headerlink" href="#value-selector" title="Permalink to this headline">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>We show two examples to demonstrate modeling from equations and modeling from
control block diagrams.</p>
<ul class="simple">
<li><p>The TGOV1 example shows code snippet for equation-based modeling
and, as well as code for block-based modeling.</p></li>
<li><p>The IEEEST example walks through the source code and explains the complete
setup, including optional parameters, input selection, and manual per-unit
conversion.</p></li>
</ul>
<div class="section" id="tgov1">
<h3>TGOV1<a class="headerlink" href="#tgov1" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="#tgov1">TGOV1</a> turbine governor model is shown as a practical example using the library.</p>
<img alt="images/example-tgov1/tgov1.png" class="align-center" src="images/example-tgov1/tgov1.png" />
<p>This model is composed of a lead-lag transfer function and a first-order lag transfer function
with an anti-windup limiter, which are sufficiently complex for demonstration.
The corresponding differential equations and algebraic equations are given below.</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\begin{split}\left[
\begin{matrix}
\dot{x}_{LG} \\
\dot{x}_{LL}
\end{matrix}
\right]
=
\left[
\begin{matrix}z_{i,lim}^{LG} \left(P_{d} - x_{LG}\right) / {T_1}
\\
\left(x_{LG} - x_{LL}\right) / T_3
\end{matrix}
\right]\end{split}\\\begin{split}\left[
\begin{matrix}
0 \\
0 \\
0 \\
0 \\
0 \\
0
\end{matrix}
\right]
=
\left[
\begin{matrix}
(1 - \omega) - \omega_{d} \\
R \times \tau_{m0} - P_{ref} \\
\left(P_{ref} + \omega_{d}\right)/R - P_{d}\\
D_{t} \omega_{d} + y_{LL}  - P_{OUT}\\
\frac{T_2}{T_3} \left(x_{LG} - x_{LL}\right) + x_{LL} - y_{LL}\\
u \left(P_{OUT} - \tau_{m0}\right)
\end{matrix}
\right]\end{split}\end{aligned}\end{align} \]</div>
<p>where <em>LG</em> and <em>LL</em> denote the lag block and the lead-lag block, <span class="math notranslate nohighlight">\(\dot{x}_{LG}\)</span> and <span class="math notranslate nohighlight">\(\dot{x}_{LL}\)</span>
are the internal states, <span class="math notranslate nohighlight">\(y_{LL}\)</span> is the lead-lag output, <span class="math notranslate nohighlight">\(\omega\)</span> the generator speed,
<span class="math notranslate nohighlight">\(\omega_d\)</span> the generator under-speed, <span class="math notranslate nohighlight">\(P_d\)</span> the droop output, <span class="math notranslate nohighlight">\(\tau_{m0}\)</span> the steady-state
torque input, and <span class="math notranslate nohighlight">\(P_{OUT}\)</span> the turbine output that will be summed at the generator.</p>
<p>The code to describe the above model using equations is given below.
The complete code can be found in class <code class="docutils literal notranslate"><span class="pre">TGOV1ModelAlt</span></code> in
<code class="docutils literal notranslate"><span class="pre">andes/models/governor.py</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
  <span class="c1"># 1. Declare parameters from case file inputs.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">NumParam</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Turbine governor droop&#39;</span><span class="p">,</span>
                    <span class="n">non_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ipower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="c1"># Other parameters are omitted.</span>

  <span class="c1"># 2. Declare external variables from generators.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">ExtState</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span>
                 <span class="n">model</span><span class="o">=</span><span class="s1">&#39;SynGen&#39;</span><span class="p">,</span>
                 <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
                 <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Generator speed&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">tm</span> <span class="o">=</span> <span class="n">ExtAlgeb</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;tm&#39;</span><span class="p">,</span>
              <span class="n">model</span><span class="o">=</span><span class="s1">&#39;SynGen&#39;</span><span class="p">,</span>
              <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
              <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;u*(pout-tm0)&#39;</span><span class="p">,</span>
              <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Generator torque input&#39;</span><span class="p">)</span>

  <span class="c1"># 3. Declare initial values from generators.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">tm0</span> <span class="o">=</span> <span class="n">ExtService</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s1">&#39;tm&#39;</span><span class="p">,</span>
               <span class="n">model</span><span class="o">=</span><span class="s1">&#39;SynGen&#39;</span><span class="p">,</span>
               <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span>
               <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Initial torque input&#39;</span><span class="p">)</span>

  <span class="c1"># 4. Declare variables and equations.</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pref</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Reference power input&#39;</span><span class="p">,</span>
                <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;tm0*R&#39;</span><span class="p">,</span>
                <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;tm0*R-pref&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">wd</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Generator under speed&#39;</span><span class="p">,</span>
              <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;(1-omega)-wd&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pd</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Droop output&#39;</span><span class="p">,</span>
              <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;tm0&#39;</span><span class="p">,</span>
              <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;(wd+pref)/R-pd&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">LG_x</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;State in the lag TF&#39;</span><span class="p">,</span>
                <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;pd&#39;</span><span class="p">,</span>
                <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;LG_lim_zi*(pd-LG_x)/T1&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">LG_lim</span> <span class="o">=</span> <span class="n">AntiWindup</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LG_x</span><span class="p">,</span>
                  <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VMIN</span><span class="p">,</span>
                  <span class="n">upper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VMAX</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">LL_x</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;State in the lead-lag TF&#39;</span><span class="p">,</span>
                <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;LG_x&#39;</span><span class="p">,</span>
                <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;(LG_x-LL_x)/T3&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">LL_y</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Lead-lag Output&#39;</span><span class="p">,</span>
                <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;LG_x&#39;</span><span class="p">,</span>
                <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;T2/T3*(LG_x-LL_x)+LL_x-LL_y&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pout</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Turbine output power&#39;</span><span class="p">,</span>
                <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;tm0&#39;</span><span class="p">,</span>
                <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;(LL_y+Dt*wd)-pout&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Another implementation of <a class="reference internal" href="#tgov1">TGOV1</a> makes extensive use of the modeling blocks.
The resulting code is more readable as follows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">TGBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="n">ConstService</span><span class="p">(</span><span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;u/R&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pref</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Reference power input&#39;</span><span class="p">,</span>
                      <span class="n">tex_name</span><span class="o">=</span><span class="s1">&#39;P_</span><span class="si">{ref}</span><span class="s1">&#39;</span><span class="p">,</span>
                      <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;tm0 * R&#39;</span><span class="p">,</span>
                      <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;tm0 * R - pref&#39;</span><span class="p">,</span>
                      <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">wd</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Generator under speed&#39;</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;p.u.&#39;</span><span class="p">,</span>
                    <span class="n">tex_name</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\omega_</span><span class="si">{dev}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">,</span>
                    <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;(wref - omega) - wd&#39;</span><span class="p">,</span>
                    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pd</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s1">&#39;Pref plus under speed times gain&#39;</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;p.u.&#39;</span><span class="p">,</span>
                    <span class="n">tex_name</span><span class="o">=</span><span class="s2">&quot;P_d&quot;</span><span class="p">,</span>
                    <span class="n">v_str</span><span class="o">=</span><span class="s1">&#39;u * tm0&#39;</span><span class="p">,</span>
                    <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;u*(wd + pref + paux) * gain - pd&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">LAG</span> <span class="o">=</span> <span class="n">LagAntiWindup</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="p">,</span>
                             <span class="n">K</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">,</span>
                             <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VMIN</span><span class="p">,</span>
                             <span class="n">upper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VMAX</span><span class="p">,</span>
                             <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">LL</span> <span class="o">=</span> <span class="n">LeadLag</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LAG_y</span><span class="p">,</span>
                      <span class="n">T1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T2</span><span class="p">,</span>
                      <span class="n">T2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T3</span><span class="p">,</span>
                      <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pout</span><span class="o">.</span><span class="n">e_str</span> <span class="o">=</span> <span class="s1">&#39;(LL_y + Dt * wd) - pout&#39;</span>
</pre></div>
</div>
<p>The complete code can be found in class <code class="docutils literal notranslate"><span class="pre">TGOV1Model</span></code> in <code class="docutils literal notranslate"><span class="pre">andes/models/governor.py</span></code>.</p>
</div>
<div class="section" id="ieeest">
<h3>IEEEST<a class="headerlink" href="#ieeest" title="Permalink to this headline">¶</a></h3>
<p>In this example, we will explain step-by-step how <a class="reference internal" href="#ieeest">IEEEST</a> is programmed.
The block diagram of IEEEST is given as follows.
We recommend you to open up the source code in <code class="docutils literal notranslate"><span class="pre">andes/models/pss.py</span></code> and
then continue reading.</p>
<img alt="images/diagrams/ieeest.png" class="align-center" src="images/diagrams/ieeest.png" />
<p>First of all, modeling components are imported at the beginning.</p>
<p>Next, <code class="docutils literal notranslate"><span class="pre">PSSBaseData</span></code> is defined to hold parameters shared by all PSSs.
<code class="docutils literal notranslate"><span class="pre">PSSBaseData</span></code> inherits from <code class="docutils literal notranslate"><span class="pre">ModelData</span></code> and calls the base constructor.
There is only one field <code class="docutils literal notranslate"><span class="pre">avr</span></code> defined for the linked exciter idx.</p>
<p>Then, <code class="docutils literal notranslate"><span class="pre">IEEESTData</span></code> defines the input parameters for IEEEST.
Use <code class="docutils literal notranslate"><span class="pre">IdxParam</span></code> for fields that store idx-es of devices that IEEEST devices link to.
Use <code class="docutils literal notranslate"><span class="pre">NumParam</span></code> for numerical parameters.</p>
<div class="section" id="pssbase">
<h4>PSSBase<a class="headerlink" href="#pssbase" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">PSSBase</span></code> is defined for the common (external) parameters, services and variables
shared by all PSSs.
The class and constructor signatures are</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSSBase</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">PSSBase</span></code> inherits from <code class="docutils literal notranslate"><span class="pre">Model</span></code> and calls the base constructor.
Note that the call to <code class="docutils literal notranslate"><span class="pre">Model</span></code>’s constructor takes two positional arguments, <code class="docutils literal notranslate"><span class="pre">system</span></code>
and <code class="docutils literal notranslate"><span class="pre">config</span></code> of types <code class="docutils literal notranslate"><span class="pre">System</span></code> and <code class="docutils literal notranslate"><span class="pre">ModelConfig</span></code>.
Next, the group is specified, and the model flags are set.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="s1">&#39;PSS&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;tds&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</pre></div>
</div>
<p>Next, <code class="docutils literal notranslate"><span class="pre">Replace</span></code> is used to replace input parameters that satisfy a lambda function
with new values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">VCUr</span> <span class="o">=</span> <span class="n">Replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VCU</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mi">999</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">VCLr</span> <span class="o">=</span> <span class="n">Replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VCL</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="o">-</span><span class="mi">999</span><span class="p">)</span>
</pre></div>
</div>
<p>The value replacement happens when <code class="docutils literal notranslate"><span class="pre">VCUr</span></code> and <code class="docutils literal notranslate"><span class="pre">VCLr</span></code> is first accessed.
<code class="docutils literal notranslate"><span class="pre">Replace</span></code> is executed in the model initialization phase (at the end of
services update).</p>
<p>Next, the indices of connected generators, buses, and bus frequency measurements
are retrieved.
Synchronous generator idx is retrieved with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span> <span class="o">=</span> <span class="n">ExtParam</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;Exciter&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s1">&#39;syn&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">avr</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Retrieved generator idx&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
<p>Using the retrieved <code class="docutils literal notranslate"><span class="pre">self.syn</span></code>, it retrieves the buses to which
the generators are connected.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ExtParam</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;SynGen&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s1">&#39;bus&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">export</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Retrieved bus idx&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
</pre></div>
</div>
<p>PSS models support an optional remote bus specified through parameter <code class="docutils literal notranslate"><span class="pre">busr</span></code>.
When <code class="docutils literal notranslate"><span class="pre">busr</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>, the generator-connected bus should be used.
The following code uses <code class="docutils literal notranslate"><span class="pre">DataSelect</span></code> to select <code class="docutils literal notranslate"><span class="pre">busr</span></code> if available but falls
back to <code class="docutils literal notranslate"><span class="pre">bus</span></code> otherwise.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">buss</span> <span class="o">=</span> <span class="n">DataSelect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">&#39;selected bus (bus or busr)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Each PSS links to a bus frequency measurement device.
If the input data does not specify one or the specified one does not exist,
<code class="docutils literal notranslate"><span class="pre">DeviceFinder</span></code> can find the correct measurement device for the bus
where frequency measurements should be taken.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">busfreq</span> <span class="o">=</span> <span class="n">DeviceFinder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">busf</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buss</span><span class="p">,</span> <span class="n">idx_name</span><span class="o">=</span><span class="s1">&#39;bus&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">busf</span></code> is the optional frequency measurement device idx, <code class="docutils literal notranslate"><span class="pre">buss</span></code> is the bus idx
for which measurement device needs to be found or created.</p>
<p>Next, external parameters, variables and services are retrieved.
Note that the PSS output <code class="docutils literal notranslate"><span class="pre">vsout</span></code> is pre-allocated but the equation string
is left to specific models.</p>
</div>
<div class="section" id="ieeestmodel">
<h4>IEEESTModel<a class="headerlink" href="#ieeestmodel" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">IEEESTModel</span></code> inherits from <code class="docutils literal notranslate"><span class="pre">PSSBase</span></code> and adds specific model components.
After calling <code class="docutils literal notranslate"><span class="pre">PSSBase</span></code>’s constructor, IEEESTModel adds config entries
to allow specifying the model for frequency measurement, because
there may be multiple frequency measurement models in the future.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;freq_model&#39;</span><span class="p">,</span> <span class="s1">&#39;BusFreq&#39;</span><span class="p">)]))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_extra</span><span class="p">(</span><span class="s1">&#39;_help&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;freq_model&#39;</span><span class="p">:</span> <span class="s1">&#39;default freq. measurement model&#39;</span><span class="p">})</span>
<span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_extra</span><span class="p">(</span><span class="s1">&#39;_alt&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;freq_model&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;BusFreq&#39;</span><span class="p">,)})</span>
</pre></div>
</div>
<p>We set the chosen measurement model to <code class="docutils literal notranslate"><span class="pre">busf</span></code> so that <code class="docutils literal notranslate"><span class="pre">DeviceFinder</span></code> knows which
model to use if it needs to create new devices.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">busf</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">freq_model</span>
</pre></div>
</div>
<p>Next, because bus voltage is an algebraic variable, we use <code class="docutils literal notranslate"><span class="pre">Derivative</span></code> to calculate
the finite difference to approximate its derivative.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">dv</span> <span class="o">=</span> <span class="n">Derivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">tex_name</span><span class="o">=</span><span class="s1">&#39;dV/dt&#39;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Finite difference of bus voltage&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, we retrieve the coefficient to convert power from machine base to system base
using <code class="docutils literal notranslate"><span class="pre">ConstService</span></code>, given by Sb / Sn.
This is needed for input mode 3, electric power in machine base.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">SnSb</span> <span class="o">=</span> <span class="n">ExtService</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;SynGen&#39;</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">indexer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">syn</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;pu_coeff&#39;</span><span class="p">,</span>
                       <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Machine base to sys base factor for power&#39;</span><span class="p">,</span>
                       <span class="n">tex_name</span><span class="o">=</span><span class="s1">&#39;(Sb/Sn)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">ExtService</span></code> access the <code class="docutils literal notranslate"><span class="pre">pu_coeff</span></code> field of the <code class="docutils literal notranslate"><span class="pre">M</span></code> variables of
synchronous generators.
Since <code class="docutils literal notranslate"><span class="pre">M</span></code> is a machine-base power quantity, <code class="docutils literal notranslate"><span class="pre">M.pu_coeff</span></code> stores the multiplication coefficient
to convert each of them from machine bases to the system base, which is Sb / Sn.</p>
<p>The input mode is parsed into boolean flags using <code class="docutils literal notranslate"><span class="pre">Switcher</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">SW</span> <span class="o">=</span> <span class="n">Switcher</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MODE</span><span class="p">,</span>
                   <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                   <span class="p">)</span>
</pre></div>
</div>
<p>where the input <code class="docutils literal notranslate"><span class="pre">u</span></code> is the MODE parameter, and <code class="docutils literal notranslate"><span class="pre">options</span></code> is a list of accepted
values.
<code class="docutils literal notranslate"><span class="pre">Switcher</span></code> boolean arrays <code class="docutils literal notranslate"><span class="pre">s0</span></code>, <code class="docutils literal notranslate"><span class="pre">s1</span></code>, …, <code class="docutils literal notranslate"><span class="pre">sN</span></code>, where <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">=</span> <span class="pre">len(options)</span> <span class="pre">-</span> <span class="pre">1</span></code>.
We added <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">options</span></code> for padding so that <code class="docutils literal notranslate"><span class="pre">SW_s1</span></code> corresponds to MODE 1.
It improves the readability of the code as we will see next.</p>
<p>The input signal <code class="docutils literal notranslate"><span class="pre">sig</span></code> is an algebraic variable given by</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">tex_name</span><span class="o">=</span><span class="s1">&#39;S_</span><span class="si">{ig}</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Input signal&#39;</span><span class="p">,</span>
                 <span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">v_str</span> <span class="o">=</span> <span class="s1">&#39;SW_s1*(omega-1) + SW_s2*0 + SW_s3*(tm0/SnSb) + &#39;</span> \
                 <span class="s1">&#39;SW_s4*(tm-tm0) + SW_s5*v + SW_s6*0&#39;</span>

<span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">e_str</span> <span class="o">=</span> <span class="s1">&#39;SW_s1*(omega-1) + SW_s2*(f-1) + SW_s3*(te/SnSb) + &#39;</span> \
                 <span class="s1">&#39;SW_s4*(tm-tm0) + SW_s5*v + SW_s6*dv_v - sig&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">v_str</span></code> and <code class="docutils literal notranslate"><span class="pre">e_str</span></code> are separated from the constructor to improve readability.
They construct piece-wise functions to select the correct initial values and equations
based on mode.
For any variables in <code class="docutils literal notranslate"><span class="pre">v_str</span></code>, they must be defined before <code class="docutils literal notranslate"><span class="pre">sig</span></code> so that
they will be initialized ahead of <code class="docutils literal notranslate"><span class="pre">sig</span></code>.
Clearly, <code class="docutils literal notranslate"><span class="pre">omega</span></code>, <code class="docutils literal notranslate"><span class="pre">tm</span></code>, and <code class="docutils literal notranslate"><span class="pre">v</span></code> are defined in <code class="docutils literal notranslate"><span class="pre">PSSBase</span></code> and thus
come before <code class="docutils literal notranslate"><span class="pre">sig</span></code>.</p>
<p>The following comes the most effective part: modeling using transfer function blocks.
We utilized several blocks to describe the model from the diagram.
Note that the output of a block is always the block name followed by <code class="docutils literal notranslate"><span class="pre">_y</span></code>.
For example, the input of <code class="docutils literal notranslate"><span class="pre">F2</span></code> is the output of <code class="docutils literal notranslate"><span class="pre">F1</span></code>, given by <code class="docutils literal notranslate"><span class="pre">F1_y</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">F1</span> <span class="o">=</span> <span class="n">Lag2ndOrd</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">T1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A1</span><span class="p">,</span> <span class="n">T2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A2</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">F2</span> <span class="o">=</span> <span class="n">LeadLag2ndOrd</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">F1_y</span><span class="p">,</span> <span class="n">T1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A3</span><span class="p">,</span> <span class="n">T2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A4</span><span class="p">,</span>
                        <span class="n">T3</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A5</span><span class="p">,</span> <span class="n">T4</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A6</span><span class="p">,</span> <span class="n">zero_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">LL1</span> <span class="o">=</span> <span class="n">LeadLag</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">F2_y</span><span class="p">,</span> <span class="n">T1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T2</span><span class="p">,</span> <span class="n">zero_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">LL2</span> <span class="o">=</span> <span class="n">LeadLag</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LL1_y</span><span class="p">,</span> <span class="n">T1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T3</span><span class="p">,</span> <span class="n">T2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T4</span><span class="p">,</span> <span class="n">zero_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">Vks</span> <span class="o">=</span> <span class="n">Gain</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LL2_y</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">KS</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">WO</span> <span class="o">=</span> <span class="n">WashoutOrLag</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Vks_y</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T6</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;WO&#39;</span><span class="p">,</span>
                       <span class="n">zero_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># WO_y == Vss</span>

<span class="bp">self</span><span class="o">.</span><span class="n">VLIM</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">WO_y</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LSMIN</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LSMAX</span><span class="p">,</span>
                    <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Vss limiter&#39;</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">Vss</span> <span class="o">=</span> <span class="n">Algeb</span><span class="p">(</span><span class="n">tex_name</span><span class="o">=</span><span class="s1">&#39;V_</span><span class="si">{ss}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="s1">&#39;Voltage output before output limiter&#39;</span><span class="p">,</span>
                 <span class="n">e_str</span><span class="o">=</span><span class="s1">&#39;VLIM_zi * WO_y + VLIM_zu * LSMAX + VLIM_zl * LSMIN - Vss&#39;</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">OLIM</span> <span class="o">=</span> <span class="n">Limiter</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VCLr</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">VCUr</span><span class="p">,</span>
                    <span class="n">info</span><span class="o">=</span><span class="s1">&#39;output limiter&#39;</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">vsout</span><span class="o">.</span><span class="n">e_str</span> <span class="o">=</span> <span class="s1">&#39;OLIM_zi * Vss - vsout&#39;</span>
</pre></div>
</div>
<p>In the end, the output equation is assigned to <code class="docutils literal notranslate"><span class="pre">vsout.e_str</span></code>.
It completes the equations of the IEEEST model.</p>
</div>
<div class="section" id="finalize">
<h4>Finalize<a class="headerlink" href="#finalize" title="Permalink to this headline">¶</a></h4>
<p>Assemble <code class="docutils literal notranslate"><span class="pre">IEEESTData</span></code> and <code class="docutils literal notranslate"><span class="pre">IEEESTModel</span></code> into <code class="docutils literal notranslate"><span class="pre">IEEEST</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IEEEST</span><span class="p">(</span><span class="n">IEEESTData</span><span class="p">,</span> <span class="n">IEEESTModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">IEEESTData</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">IEEESTModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>Locate <code class="docutils literal notranslate"><span class="pre">andes/models/__init__.py</span></code>, in <code class="docutils literal notranslate"><span class="pre">file_classes</span></code>,
find the key <code class="docutils literal notranslate"><span class="pre">pss</span></code> and add <code class="docutils literal notranslate"><span class="pre">IEEEST</span></code> to its value list.
In <code class="docutils literal notranslate"><span class="pre">file_classes</span></code>, keys are the <code class="docutils literal notranslate"><span class="pre">.py</span></code> file names under the folder <code class="docutils literal notranslate"><span class="pre">models</span></code>,
and values are class names to be imported from that file.
If the file name does not exist as a key in <code class="docutils literal notranslate"><span class="pre">file_classes</span></code>,
add it after all prerequisite models.
For example, PSS should be added after exciters (and generators,
of course).</p>
<p>Finally, locate <code class="docutils literal notranslate"><span class="pre">andes/models/group.py</span></code>, check if the class
with <code class="docutils literal notranslate"><span class="pre">PSS</span></code> exist.
It is the name of IEEEST’s group name.
If not, create one by inheriting from <code class="docutils literal notranslate"><span class="pre">GroupBase</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PSS</span><span class="p">(</span><span class="n">GroupBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Power system stabilizer group.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_vars</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s1">&#39;vsout&#39;</span><span class="p">,))</span>
</pre></div>
</div>
<p>where we added <code class="docutils literal notranslate"><span class="pre">vsout</span></code> to the <code class="docutils literal notranslate"><span class="pre">common_vars</span></code> list.
All models in the PSS group must have a variable named
<code class="docutils literal notranslate"><span class="pre">vsout</span></code>, which is defined in <code class="docutils literal notranslate"><span class="pre">PSSBase</span></code>.</p>
<p>This completes the IEEEST model.
When developing new models, use <code class="docutils literal notranslate"><span class="pre">andes</span> <span class="pre">prepare</span></code> to generate numerical code and
start debugging.</p>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">IntelliHealer</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Yichen Zhang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/modeling.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>